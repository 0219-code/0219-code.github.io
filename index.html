<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜¥æ™šé­”æœ¯è®¡ç®—å™¨ Â· ç›¸åŒå››ä½æ•°è§¦å‘ Â· ç­‰å·å¯ç”¨</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, system-ui, sans-serif;
            user-select: none;
        }
        body {
            background: linear-gradient(145deg, #2b2e3a 0%, #1e2129 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            padding: 12px;
        }
        .calculator {
            width: 620px;
            background: #3a3f4b;
            border-radius: 24px;
            padding: 24px 20px 30px 20px;
            box-shadow: 0 25px 40px rgba(0, 0, 0, 0.5), inset 0 1px 3px rgba(255, 255, 255, 0.1);
            border: 1px solid #5f6675;
        }
        .time-panel {
            background: #282c36;
            color: #d4dcec;
            padding: 12px 18px;
            border-radius: 60px;
            margin-bottom: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            font-size: 1.1rem;
            border: 1px solid #4f5666;
            box-shadow: inset 0 2px 5px #15181f;
        }
        .time-label {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .magic-number {
            background: #1b1f29;
            padding: 5px 16px;
            border-radius: 40px;
            color: #f5dd9d;
            font-family: 'Courier New', monospace;
            font-size: 1.4rem;
            font-weight: 700;
            border: 1px solid #7a6240;
            box-shadow: inset 0 0 8px #00000055;
        }
        .display-wrap {
            background: #232732;
            border-radius: 16px;
            padding: 12px 20px;
            margin-bottom: 16px;
            text-align: right;
            border: 2px solid #515a6b;
            box-shadow: inset 0 4px 8px #0b0d12;
        }
        .display {
            font-size: 3.4rem;
            font-weight: 600;
            font-family: 'Courier New', monospace;
            color: #f2f6ff;
            line-height: 1.2;
            min-height: 85px;
            text-shadow: 0 0 8px #729fcf66;
            word-wrap: break-word;
        }
        .button-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .btn {
            background: #4e5464;
            border: none;
            border-radius: 16px;
            padding: 14px 0;
            font-size: 1.3rem;
            font-weight: 500;
            color: #edf2fc;
            box-shadow: 0 6px 0 #2a2e38, 0 8px 10px rgba(0,0,0,0.4);
            transition: all 0.06s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #6b7385;
        }
        .btn:active {
            transform: translateY(5px);
            box-shadow: 0 2px 0 #2a2e38, 0 5px 8px rgba(0,0,0,0.4);
        }
        .btn.function {
            background: #656d82;
            font-size: 1.1rem;
        }
        .btn.operator {
            background: #f09b4b;
            color: #1f1e2b;
            font-weight: 700;
            box-shadow: 0 6px 0 #b4621e, 0 8px 10px rgba(0,0,0,0.4);
            border-color: #ffbc6e;
        }
        .btn.operator:active {
            transform: translateY(5px);
            box-shadow: 0 2px 0 #b4621e, 0 5px 8px rgba(0,0,0,0.4);
        }
        .btn.equals {
            background: #3f76b9;
            box-shadow: 0 6px 0 #1f4980, 0 8px 10px rgba(0,0,0,0.4);
            border-color: #8cb2e0;
        }
        .btn.memory {
            background: #5d5f6e;
            font-size: 1rem;
        }
        .btn.zero {
            grid-column: span 2;
        }
        .btn:disabled {
            opacity: 0.3;
            filter: grayscale(80%);
            transform: none;
            pointer-events: none;
            box-shadow: 0 4px 0 #2a2e38;
        }
        .footer-note {
            color: #8f99aa;
            text-align: center;
            margin-top: 20px;
            font-size: 0.8rem;
        }
        .magic-hint {
            font-size: 0.9rem;
            color: #b4bbd0;
            background: #2f3542;
            border-radius: 40px;
            padding: 4px 12px;
        }
    </style>
</head>
<body>
<div class="calculator">
    <div class="time-panel">
        <div class="time-label">
            <span>ğŸ“… å½“å‰æ—¶é—´</span>
            <span id="currentTimeStr" style="font-family: monospace;">--</span>
        </div>
        <div class="magic-number" id="magicPreview">--</div>
    </div>

    <div class="display-wrap">
        <div class="display" id="display">0</div>
    </div>

    <div class="button-grid">
        <button class="btn function" data-action="sin">sin</button>
        <button class="btn function" data-action="cos">cos</button>
        <button class="btn function" data-action="tan">tan</button>
        <button class="btn function" data-action="ln">ln</button>
        <button class="btn function" data-action="log">log</button>
        <button class="btn function" data-action="sqrt">âˆš</button>

        <button class="btn memory" data-action="mc">MC</button>
        <button class="btn memory" data-action="mr">MR</button>
        <button class="btn memory" data-action="m+">M+</button>
        <button class="btn memory" data-action="ms">MS</button>
        <button class="btn function" data-action="x2">xÂ²</button>
        <button class="btn function" data-action="1x">1/x</button>

        <button class="btn function" data-action="%">%</button>
        <button class="btn function" data-action="ce">CE</button>
        <button class="btn function" data-action="c">C</button>
        <button class="btn function" data-action="back">âŒ«</button>
        <button class="btn function" data-action="pow">xÊ¸</button>
        <button class="btn operator" data-action="/">Ã·</button>

        <button class="btn" data-action="num">7</button>
        <button class="btn" data-action="num">8</button>
        <button class="btn" data-action="num">9</button>
        <button class="btn operator" data-action="*">Ã—</button>
        <button class="btn function" data-action="fact">n!</button>
        <button class="btn operator" data-action="+">+</button>

        <button class="btn" data-action="num">4</button>
        <button class="btn" data-action="num">5</button>
        <button class="btn" data-action="num">6</button>
        <button class="btn operator" data-action="-">âˆ’</button>
        <button class="btn function" data-action="mod">mod</button>
        <button class="btn operator" data-action="+">+</button>

        <button class="btn" data-action="num">1</button>
        <button class="btn" data-action="num">2</button>
        <button class="btn" data-action="num">3</button>
        <button class="btn function" data-action="exp">exp</button>
        <button class="btn function" data-action="rand">rand</button>
        <button class="btn equals" data-action="=">=</button>

        <button class="btn zero" data-action="num">0</button>
        <button class="btn" data-action=".">.</button>
        <button class="btn function" data-action="Â±">Â±</button>
        <button class="btn function" data-action="pi">Ï€</button>
        <button class="btn function" data-action="e">e</button>
        <button class="btn function" data-action="(">(</button>
    </div>

    <div class="footer-note">
        <span class="magic-hint">âœ¨ é­”æœ¯: ä¸¤ä¸ªç›¸åŒçš„å››ä½æ•°åæŒ‰ä¸¤æ¬¡ + â†’ ç¬¬ä¸‰æ•°å˜æˆæ—¶é—´é­”æ•°ï¼Œç­‰å·å¯ç”¨</span>
    </div>
</div>

<script>
(function() {
    // ---------- è·å–å½“å‰æ—¶é—´å¹¶ç”Ÿæˆé­”æœ¯æ•° (æœˆ+æ—¥+æ—¶+åˆ†) ----------
    function getMagicFromTime() {
        const now = new Date();
        const month = now.getMonth() + 1;          // 1-12ï¼Œä¸è¡¥é›¶
        const day = now.getDate().toString().padStart(2, '0');
        const hour = now.getHours().toString().padStart(2, '0');
        const minute = now.getMinutes().toString().padStart(2, '0');
        return `${month}${day}${hour}${minute}`;
    }

    function updateTimeDisplay() {
        const now = new Date();
        const y = now.getFullYear();
        const m = (now.getMonth()+1).toString().padStart(2,'0');
        const d = now.getDate().toString().padStart(2,'0');
        const h = now.getHours().toString().padStart(2,'0');
        const min = now.getMinutes().toString().padStart(2,'0');
        document.getElementById('currentTimeStr').innerText = `${y}-${m}-${d} ${h}:${min}`;
        document.getElementById('magicPreview').innerText = getMagicFromTime();
    }
    updateTimeDisplay();
    setInterval(updateTimeDisplay, 1000); // æ¯ç§’åˆ·æ–°

    // ---------- è®¡ç®—å™¨æ ¸å¿ƒå˜é‡ ----------
    const display = document.getElementById('display');
    let displayValue = '0';
    let firstOperand = null;      // ç¬¬ä¸€ä¸ªæ“ä½œæ•°
    let operator = null;          // å½“å‰è¿ç®—ç¬¦
    let waitingForSecond = false; // æ˜¯å¦ç­‰å¾…è¾“å…¥ç¬¬äºŒä¸ªæ“ä½œæ•°
    let magicReady = false;       // é­”æœ¯é¢„å¤‡è§¦å‘
    let magicLock = false;        // é­”æœ¯å·²è§¦å‘ï¼Œé”å®šæ•°å­—é”®
    let frozen = false;           // æ˜¯å¦å†»ç»“ï¼ˆé­”æœ¯æˆåŠŸåé™¤Cå’Œç­‰å·å¤–ç¦ç”¨ï¼‰
    let lastFirstValid = false;   // ç¬¬ä¸€ä¸ªæ•°æ˜¯å¦ä¸ºå››ä½æ•°
    let memory = 0;

    // æ‰€æœ‰æŒ‰é’®ï¼Œç”¨äºæ§åˆ¶ç¦ç”¨çŠ¶æ€
    const allButtons = document.querySelectorAll('.btn');
    function setButtonsEnabled(enabled) {
        allButtons.forEach(btn => {
            if (btn.dataset.action === 'c' || btn.dataset.action === 'ce') {
                btn.disabled = false; // C/CEå§‹ç»ˆå¯ç”¨
            } else if (btn.dataset.action === '=') {
                btn.disabled = false; // ç­‰å·å§‹ç»ˆå¯ç”¨ï¼ˆå³ä½¿å†»ç»“ï¼‰
            } else {
                btn.disabled = !enabled;
            }
        });
    }

    // è¾…åŠ©ï¼šåˆ¤æ–­æ˜¯å¦ä¸ºå››ä½æ­£æ•´æ•°
    function isFourDigitNumber(str) {
        if (typeof str !== 'string') return false;
        if (!/^\d+$/.test(str)) return false;
        if (str.length !== 4) return false;
        const num = Number(str);
        return num >= 1000 && num <= 9999;
    }

    function updateDisplay(val) {
        displayValue = val.toString();
        display.innerText = displayValue;
    }

    // æ•°å­—è¾“å…¥
    function handleDigit(digit) {
        if (frozen || magicLock) return; // å†»ç»“æˆ–é”å®šæ—¶ä¸å“åº”æ•°å­—

        // é­”æœ¯è§¦å‘ï¼šå¤„äºé¢„å¤‡ä¸”ç­‰å¾…ç¬¬ä¸‰ä¸ªæ•°
        if (magicReady && waitingForSecond) {
            // è®¡ç®—å‰ä¸¤ä¸ªæ•°çš„å’Œ (a + b)
            const sum = firstOperand + parseFloat(displayValue);
            firstOperand = sum;          // ä¿å­˜å’Œä½œä¸ºç¬¬ä¸€ä¸ªæ“ä½œæ•°
            operator = '+';              // ä¿æŒåŠ æ³•è¿ç®—ç¬¦
            waitingForSecond = false;    // ä¸å†ç­‰å¾…ç¬¬äºŒæ“ä½œæ•°

            const magicNum = getMagicFromTime();
            updateDisplay(magicNum);     // æ˜¾ç¤ºé­”æœ¯æ—¶é—´

            magicReady = false;
            magicLock = true;             // é”å®šåç»­æ•°å­—è¾“å…¥
            frozen = true;                 // è¿›å…¥å†»ç»“çŠ¶æ€
            setButtonsEnabled(false);      // ç¦ç”¨é™¤Cå’Œç­‰å·å¤–çš„æ‰€æœ‰æŒ‰é’®
            return;
        }

        if (waitingForSecond) {
            displayValue = digit;
            waitingForSecond = false;
        } else {
            displayValue = displayValue === '0' ? digit : displayValue + digit;
        }
        updateDisplay(displayValue);
    }

    // è¿ç®—ç¬¦å¤„ç†
    function handleOperator(op) {
        // å†»ç»“çŠ¶æ€ä¸‹åªå…è®¸ç­‰å·æ“ä½œï¼Œå…¶ä»–æ“ä½œç›´æ¥è¿”å›
        if (frozen && op !== '=') return;

        const current = parseFloat(displayValue);

        if (op === '=') {
            if (operator && !waitingForSecond && firstOperand !== null) {
                let result;
                switch (operator) {
                    case '+': result = firstOperand + current; break;
                    case '-': result = firstOperand - current; break;
                    case '*': result = firstOperand * current; break;
                    case '/': result = current !== 0 ? firstOperand / current : NaN; break;
                    default: result = current;
                }
                if (isNaN(result)) updateDisplay('é”™è¯¯');
                else updateDisplay(parseFloat(result.toFixed(10)).toString());
                // è®¡ç®—åä¸æ¸…é™¤å†»ç»“ï¼Ÿç­‰å·åä»ä¿æŒå†»ç»“ï¼Ÿæ ¹æ®éœ€æ±‚ï¼Œç­‰å·åä»ç„¶å†»ç»“ï¼Œç›´åˆ°æŒ‰C
                // ä½†éœ€è¦é‡ç½®æ“ä½œæ•°é˜²æ­¢åç»­è¯¯æ“ä½œ
                firstOperand = null;
                operator = null;
                waitingForSecond = false;
                // ä¿æŒ frozen ä¸º trueï¼Œä½†ä¿ç•™ç­‰å·å¯ç”¨
            }
            return;
        }

        // å•ç›®è¿ç®—ç¬¦
        if (['sin','cos','tan','ln','log','sqrt','x2','1x','%','Â±','exp','fact','rand','pi','e'].includes(op)) {
            applyUnary(op, current);
            return;
        }

        // å¤„ç†åŠ æ³•é­”æœ¯é€»è¾‘
        if (op === '+') {
            if (firstOperand === null) {
                // ç¬¬ä¸€æ¬¡æŒ‰+ï¼šå­˜å‚¨ç¬¬ä¸€ä¸ªæ•°
                firstOperand = current;
                lastFirstValid = isFourDigitNumber(displayValue);
                operator = '+';
                waitingForSecond = true;
                return;
            } else {
                // ç¬¬äºŒæ¬¡æŒ‰+ï¼šæ­¤æ—¶displayValueæ˜¯ç¬¬äºŒä¸ªæ•°
                const a = firstOperand;
                const b = current;

                if (lastFirstValid && isFourDigitNumber(displayValue) && a === b) {
                    // æ»¡è¶³é­”æœ¯æ¡ä»¶ï¼šæ˜¾ç¤ºç¬¬äºŒä¸ªæ•°ï¼Œæ¿€æ´»é¢„å¤‡
                    updateDisplay(b.toString()); // ç¡®ä¿æ˜¾ç¤ºç¬¬äºŒä¸ªæ•°
                    waitingForSecond = true;      // ç­‰å¾…ç¬¬ä¸‰ä¸ªæ•°
                    magicReady = true;             // ä¸‹æ¬¡æ•°å­—è¾“å…¥è§¦å‘é­”æœ¯
                    operator = '+';                // ä¿æŒè¿ç®—ç¬¦
                } else {
                    // ä¸æ»¡è¶³é­”æœ¯ï¼šæ˜¾ç¤ºa+bï¼Œå¹¶é‡ç½®çŠ¶æ€
                    const sum = a + b;
                    updateDisplay(sum.toString());
                    firstOperand = null;
                    operator = null;
                    waitingForSecond = false;
                    magicReady = false;
                }
                return;
            }
        }

        // å…¶ä»–åŒç›®è¿ç®—ç¬¦ï¼ˆå¸¸è§„å¤„ç†ï¼‰
        if (firstOperand === null) {
            firstOperand = current;
            lastFirstValid = false; // éåŠ æ³•ä¸è®°å½•å››ä½æ•°çŠ¶æ€
            operator = op;
            waitingForSecond = true;
        } else if (!waitingForSecond) {
            let intermediate;
            switch (operator) {
                case '+': intermediate = firstOperand + current; break;
                case '-': intermediate = firstOperand - current; break;
                case '*': intermediate = firstOperand * current; break;
                case '/': intermediate = current !== 0 ? firstOperand / current : NaN; break;
                default: intermediate = current;
            }
            if (isNaN(intermediate)) { updateDisplay('é”™è¯¯'); resetAll(); return; }
            firstOperand = intermediate;
            updateDisplay(firstOperand.toString());
            operator = op;
            waitingForSecond = true;
        } else {
            operator = op;
            waitingForSecond = true;
        }
    }

    // å•ç›®è¿ç®—
    function applyUnary(cmd, value) {
        if (frozen) return;
        let res;
        switch (cmd) {
            case 'sin': res = Math.sin(value); break;
            case 'cos': res = Math.cos(value); break;
            case 'tan': res = Math.tan(value); break;
            case 'ln': res = Math.log(value); break;
            case 'log': res = Math.log10(value); break;
            case 'sqrt': res = Math.sqrt(value); break;
            case 'x2': res = value * value; break;
            case '1x': res = 1 / value; break;
            case '%': res = value / 100; break;
            case 'Â±': res = -value; break;
            case 'exp': res = Math.exp(value); break;
            case 'fact':
                if (value < 0 || !Number.isInteger(value)) res = NaN;
                else { let f = 1; for (let i = 2; i <= value; i++) f *= i; res = f; }
                break;
            case 'rand': res = Math.random(); break;
            case 'pi': res = Math.PI; break;
            case 'e': res = Math.E; break;
            default: return;
        }
        if (isNaN(res) || !isFinite(res)) updateDisplay('é”™è¯¯');
        else updateDisplay(parseFloat(res.toFixed(10)).toString());
        firstOperand = null;
        operator = null;
        waitingForSecond = false;
        magicReady = false;
        magicLock = false;
        frozen = false;
        setButtonsEnabled(true);
    }

    // å‘½ä»¤å¤„ç†
    function handleCommand(cmd) {
        if (cmd === 'c' || cmd === 'ce') {
            // é‡ç½®æ‰€æœ‰å¹¶è§£å†»
            displayValue = '0';
            firstOperand = null;
            operator = null;
            waitingForSecond = false;
            magicReady = false;
            magicLock = false;
            frozen = false;
            lastFirstValid = false;
            updateDisplay('0');
            setButtonsEnabled(true);
            return;
        }
        if (frozen) return;

        switch (cmd) {
            case 'back':
                displayValue = displayValue.length > 1 ? displayValue.slice(0, -1) : '0';
                updateDisplay(displayValue);
                break;
            case 'mc': memory = 0; break;
            case 'mr': displayValue = memory.toString(); updateDisplay(displayValue); waitingForSecond = false; break;
            case 'm+': memory += parseFloat(displayValue) || 0; break;
            case 'ms': memory = parseFloat(displayValue) || 0; break;
            default: break;
        }
    }

    function resetAll() {
        displayValue = '0';
        firstOperand = null;
        operator = null;
        waitingForSecond = false;
        magicReady = false;
        magicLock = false;
        frozen = false;
        lastFirstValid = false;
        updateDisplay('0');
        setButtonsEnabled(true);
    }

    // æŒ‰é’®äº‹ä»¶ç»‘å®š
    document.querySelectorAll('.btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const action = btn.dataset.action;
            const text = btn.innerText;

            if (action === 'num') {
                if (text === '.' && displayValue.includes('.')) return;
                handleDigit(text);
            } else if (action === '=') {
                handleOperator('=');
            } else if (['+', '-', '*', '/', 'mod', 'pow'].includes(action) || text === '+' || text === 'âˆ’' || text === 'Ã—' || text === 'Ã·') {
                let op = text;
                if (text === 'Ã—') op = '*';
                else if (text === 'Ã·') op = '/';
                else if (text === 'âˆ’') op = '-';
                else if (text === 'mod') op = '%';
                else if (text === 'xÊ¸') op = '^';
                handleOperator(op);
            } else if (action === 'c' || action === 'ce' || action === 'back' || ['mc','mr','m+','ms'].includes(action)) {
                handleCommand(action);
            } else if (action) {
                const val = parseFloat(displayValue) || 0;
                applyUnary(action, val);
            }
        });
    });

    // ç®€åŒ–å¤„ç† mod å’Œ pow
    document.querySelectorAll('.btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            const txt = this.innerText;
            if (txt === 'mod' || txt === 'xÊ¸') {
                e.stopImmediatePropagation();
                if (frozen) return;
                const current = parseFloat(displayValue);
                if (firstOperand === null) {
                    firstOperand = current;
                } else if (operator && !waitingForSecond) {
                    let res;
                    if (txt === 'xÊ¸') res = Math.pow(firstOperand, current);
                    else res = firstOperand % current;
                    if (!isNaN(res)) updateDisplay(res.toString());
                    firstOperand = res;
                }
                operator = (txt === 'xÊ¸') ? '^' : '%';
                waitingForSecond = true;
                magicReady = false;
                magicLock = false;
            }
        });
    });

    // é”®ç›˜æ”¯æŒ
    document.addEventListener('keydown', (e) => {
        // å¦‚æœå·²å†»ç»“ï¼Œåªå…è®¸ Escape å’Œ Enter/=
        if (frozen) {
            if (e.key === 'Escape') {
                e.preventDefault();
                document.querySelector('[data-action="c"]')?.click();
            } else if (e.key === 'Enter' || e.key === '=') {
                e.preventDefault();
                document.querySelector('[data-action="="]')?.click();
            }
            return;
        }

        const key = e.key;
        const allowedKeys = ['/', '*', 'Enter', 'Escape', 'Backspace', 'Delete', '+', '-', '.', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
        if (allowedKeys.includes(key)) {
            e.preventDefault();
        }

        if (key === '/') {
            document.querySelector('[data-action="/"]')?.click();
        } else if (key === '*') {
            document.querySelector('[data-action="*"]')?.click();
        } else if (key === 'Enter' || key === '=') {
            document.querySelector('[data-action="="]')?.click();
        } else if (key === 'Escape') {
            document.querySelector('[data-action="c"]')?.click();
        } else if (key === 'Backspace') {
            document.querySelector('[data-action="back"]')?.click();
        } else if (key === '+') {
            document.querySelectorAll('[data-action="+"]')[0]?.click();
        } else if (key === '-') {
            document.querySelector('[data-action="-"]')?.click();
        } else if (key === '.') {
            document.querySelector('[data-action="."]')?.click();
        } else if (key >= '0' && key <= '9') {
            const numBtn = Array.from(document.querySelectorAll('[data-action="num"]')).find(btn => btn.innerText === key);
            numBtn?.click();
        }
    });

    resetAll();
})();
</script>
</body>
</html>
