<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜¥æ™šé­”æœ¯è®¡ç®—å™¨ Â· ç›¸ç­‰å››ä½æ•°è§¦å‘</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, system-ui, sans-serif;
            user-select: none;
        }
        body {
            background: linear-gradient(145deg, #2b2e3a 0%, #1e2129 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            padding: 12px;
        }
        .calculator {
            width: 620px;
            background: #3a3f4b;
            border-radius: 24px;
            padding: 24px 20px 30px 20px;
            box-shadow: 0 25px 40px rgba(0, 0, 0, 0.5), inset 0 1px 3px rgba(255, 255, 255, 0.1);
            border: 1px solid #5f6675;
        }
        .time-panel {
            background: #282c36;
            color: #d4dcec;
            padding: 12px 18px;
            border-radius: 60px;
            margin-bottom: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            font-size: 1.1rem;
            border: 1px solid #4f5666;
            box-shadow: inset 0 2px 5px #15181f;
        }
        .time-label {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .magic-number {
            background: #1b1f29;
            padding: 5px 16px;
            border-radius: 40px;
            color: #f5dd9d;
            font-family: 'Courier New', monospace;
            font-size: 1.4rem;
            font-weight: 700;
            border: 1px solid #7a6240;
            box-shadow: inset 0 0 8px #00000055;
        }
        .display-wrap {
            background: #232732;
            border-radius: 16px;
            padding: 12px 20px;
            margin-bottom: 16px;
            text-align: right;
            border: 2px solid #515a6b;
            box-shadow: inset 0 4px 8px #0b0d12;
        }
        .display {
            font-size: 3.4rem;
            font-weight: 600;
            font-family: 'Courier New', monospace;
            color: #f2f6ff;
            line-height: 1.2;
            min-height: 85px;
            text-shadow: 0 0 8px #729fcf66;
        }
        .button-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .btn {
            background: #4e5464;
            border: none;
            border-radius: 16px;
            padding: 14px 0;
            font-size: 1.3rem;
            font-weight: 500;
            color: #edf2fc;
            box-shadow: 0 6px 0 #2a2e38, 0 8px 10px rgba(0,0,0,0.4);
            transition: all 0.06s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #6b7385;
        }
        .btn:active {
            transform: translateY(5px);
            box-shadow: 0 2px 0 #2a2e38, 0 5px 8px rgba(0,0,0,0.4);
        }
        .btn.function {
            background: #656d82;
            font-size: 1.1rem;
        }
        .btn.operator {
            background: #f09b4b;
            color: #1f1e2b;
            font-weight: 700;
            box-shadow: 0 6px 0 #b4621e, 0 8px 10px rgba(0,0,0,0.4);
            border-color: #ffbc6e;
        }
        .btn.operator:active {
            transform: translateY(5px);
            box-shadow: 0 2px 0 #b4621e, 0 5px 8px rgba(0,0,0,0.4);
        }
        .btn.equals {
            background: #3f76b9;
            box-shadow: 0 6px 0 #1f4980, 0 8px 10px rgba(0,0,0,0.4);
            border-color: #8cb2e0;
        }
        .btn.memory {
            background: #5d5f6e;
            font-size: 1rem;
        }
        .btn.zero {
            grid-column: span 2;
        }
        .footer-note {
            color: #8f99aa;
            text-align: center;
            margin-top: 20px;
            font-size: 0.8rem;
        }
        .magic-hint {
            font-size: 0.9rem;
            color: #b4bbd0;
            background: #2f3542;
            border-radius: 40px;
            padding: 4px 12px;
        }
    </style>
</head>
<body>
<div class="calculator">
    <div class="time-panel">
        <div class="time-label">
            <span>ğŸ“… å½“å‰æ—¶é—´</span>
            <span id="currentTimeStr" style="font-family: monospace;">2026-02-17 17:20</span>
        </div>
        <div class="magic-number" id="magicPreview">2171720</div>
    </div>

    <div class="display-wrap">
        <div class="display" id="display">0</div>
    </div>

    <div class="button-grid">
        <!-- ç¬¬ä¸€è¡Œ ç§‘å­¦/å†…å­˜ -->
        <button class="btn function" data-action="sin">sin</button>
        <button class="btn function" data-action="cos">cos</button>
        <button class="btn function" data-action="tan">tan</button>
        <button class="btn function" data-action="ln">ln</button>
        <button class="btn function" data-action="log">log</button>
        <button class="btn function" data-action="sqrt">âˆš</button>

        <!-- ç¬¬äºŒè¡Œ -->
        <button class="btn memory" data-action="mc">MC</button>
        <button class="btn memory" data-action="mr">MR</button>
        <button class="btn memory" data-action="m+">M+</button>
        <button class="btn memory" data-action="ms">MS</button>
        <button class="btn function" data-action="x2">xÂ²</button>
        <button class="btn function" data-action="1x">1/x</button>

        <!-- ç¬¬ä¸‰è¡Œ -->
        <button class="btn function" data-action="%">%</button>
        <button class="btn function" data-action="ce">CE</button>
        <button class="btn function" data-action="c">C</button>
        <button class="btn function" data-action="back">âŒ«</button>
        <button class="btn function" data-action="pow">xÊ¸</button>
        <button class="btn operator" data-action="/">Ã·</button>

        <!-- ç¬¬å››è¡Œ -->
        <button class="btn" data-action="num">7</button>
        <button class="btn" data-action="num">8</button>
        <button class="btn" data-action="num">9</button>
        <button class="btn operator" data-action="*">Ã—</button>
        <button class="btn function" data-action="fact">n!</button>
        <button class="btn operator" data-action="+">+</button>

        <!-- ç¬¬äº”è¡Œ -->
        <button class="btn" data-action="num">4</button>
        <button class="btn" data-action="num">5</button>
        <button class="btn" data-action="num">6</button>
        <button class="btn operator" data-action="-">âˆ’</button>
        <button class="btn function" data-action="mod">mod</button>
        <button class="btn operator" data-action="+">+</button>   <!-- ç¬¬äºŒä¸ª+ -->

        <!-- ç¬¬å…­è¡Œ -->
        <button class="btn" data-action="num">1</button>
        <button class="btn" data-action="num">2</button>
        <button class="btn" data-action="num">3</button>
        <button class="btn function" data-action="exp">exp</button>
        <button class="btn function" data-action="rand">rand</button>
        <button class="btn equals" data-action="=">=</button>

        <!-- ç¬¬ä¸ƒè¡Œ -->
        <button class="btn zero" data-action="num">0</button>
        <button class="btn" data-action=".">.</button>
        <button class="btn function" data-action="Â±">Â±</button>
        <button class="btn function" data-action="pi">Ï€</button>
        <button class="btn function" data-action="e">e</button>
        <button class="btn function" data-action="(">(</button>
    </div>

    <div class="footer-note">
        <span class="magic-hint">âœ¨ é­”æœ¯: ä¸¤ä¸ªç›¸åŒçš„å››ä½æ•° + (ä»»æ„æ•°) â†’ ç¬¬ä¸‰æ•°è‡ªåŠ¨å˜æˆä¸Šæ–¹é­”æ•°</span>
    </div>
</div>

<script>
(function() {
    // ---------- è·å–å½“å‰æ—¶é—´å¹¶ç”Ÿæˆé­”æœ¯æ•° ----------
    function getMagicFromTime() {
        const now = new Date();
        const month = now.getMonth() + 1;
        const day = now.getDate().toString().padStart(2, '0');
        const hour = now.getHours().toString().padStart(2, '0');
        const minute = now.getMinutes().toString().padStart(2, '0');
        return `${month}${day}${hour}${minute}`;
    }

    function updateTimeDisplay() {
        const now = new Date();
        const y = now.getFullYear();
        const m = (now.getMonth()+1).toString().padStart(2,'0');
        const d = now.getDate().toString().padStart(2,'0');
        const h = now.getHours().toString().padStart(2,'0');
        const min = now.getMinutes().toString().padStart(2,'0');
        document.getElementById('currentTimeStr').innerText = `${y}-${m}-${d} ${h}:${min}`;
        document.getElementById('magicPreview').innerText = getMagicFromTime();
    }
    updateTimeDisplay();
    setInterval(updateTimeDisplay, 1000);

    // ---------- è®¡ç®—å™¨æ ¸å¿ƒå˜é‡ ----------
    let display = document.getElementById('display');
    let displayValue = '0';
    let firstOperand = null;          // ç¬¬ä¸€ä¸ªæ“ä½œæ•°
    let secondOperand = null;         // ç”¨äºé­”æœ¯æ—¶æš‚å­˜ç¬¬äºŒä¸ªæ“ä½œæ•°
    let operator = null;              // å½“å‰è¿ç®—ç¬¦
    let waitingForSecond = false;     // æ˜¯å¦ç­‰å¾…è¾“å…¥ç¬¬äºŒä¸ªæ“ä½œæ•°
    let magicReady = false;           // é­”æœ¯å‡†å¤‡è§¦å‘
    let memory = 0;

    // è¾…åŠ©ï¼šåˆ¤æ–­æ˜¯å¦ä¸ºå››ä½æ­£æ•´æ•°
    function isFourDigitNumber(str) {
        if (typeof str !== 'string') return false;
        if (!/^\d+$/.test(str)) return false;
        if (str.length !== 4) return false;
        const num = Number(str);
        return num >= 1000 && num <= 9999;
    }

    function updateDisplay(val) {
        displayValue = val.toString();
        display.innerText = displayValue;
    }

    // ---------- æ•°å­—è¾“å…¥ ----------
    function handleDigit(digit) {
        // å¦‚æœå¤„äºé­”æœ¯é¢„å¤‡çŠ¶æ€ï¼Œåˆ™è§¦å‘é­”æœ¯æ›¿æ¢
        if (magicReady && waitingForSecond) {
            // è®¡ç®—å‰ä¸¤ä¸ªæ•°çš„å’Œï¼Œä½œä¸ºæ–°çš„ firstOperand
            const sum = firstOperand + secondOperand;
            firstOperand = sum;
            // æ˜¾ç¤ºé­”æœ¯æ•°
            const magicNum = getMagicFromTime();
            updateDisplay(magicNum);
            // æ¸…é™¤é­”æœ¯çŠ¶æ€
            magicReady = false;
            secondOperand = null;
            waitingForSecond = false;   // å½“å‰æ˜¾ç¤ºé­”æœ¯æ•°ï¼Œå¯ä½œä¸ºä¸‹ä¸€ä¸ªæ“ä½œæ•°
            return;
        }

        // æ™®é€šæ•°å­—è¾“å…¥
        if (waitingForSecond) {
            displayValue = digit;
            waitingForSecond = false;
        } else {
            displayValue = displayValue === '0' ? digit : displayValue + digit;
        }
        updateDisplay(displayValue);
    }

    // ---------- è¿ç®—ç¬¦å¤„ç† ----------
    function handleOperator(op) {
        const current = parseFloat(displayValue);

        // ç­‰å·å¤„ç†
        if (op === '=') {
            if (operator && !waitingForSecond && firstOperand !== null) {
                let result;
                switch (operator) {
                    case '+': result = firstOperand + current; break;
                    case '-': result = firstOperand - current; break;
                    case '*': result = firstOperand * current; break;
                    case '/': result = current !== 0 ? firstOperand / current : NaN; break;
                    default: result = current;
                }
                if (isNaN(result)) updateDisplay('é”™è¯¯');
                else updateDisplay(parseFloat(result.toFixed(10)).toString());
                firstOperand = null;
                operator = null;
                waitingForSecond = false;
                magicReady = false;
                secondOperand = null;
            }
            return;
        }

        // å•ç›®è¿ç®—ç¬¦ï¼ˆç®€ç•¥å®ç°ï¼‰
        if (['sin','cos','tan','ln','log','sqrt','x2','1x','%','Â±','exp','fact','rand','pi','e'].includes(op)) {
            applyUnary(op, current);
            return;
        }

        // åŒç›®è¿ç®—ç¬¦å¤„ç†
        if (firstOperand === null) {
            // ç¬¬ä¸€ä¸ªæ“ä½œæ•°
            firstOperand = current;
            operator = op;
            waitingForSecond = true;
            magicReady = false;   // æ–°å¼€å§‹ï¼Œæ¸…é™¤é­”æœ¯é¢„å¤‡
            secondOperand = null;
        } else if (!waitingForSecond) {
            // å·²ç»æœ‰ä¸¤ä¸ªæ“ä½œæ•°ï¼ˆåˆšè¾“å…¥å®Œç¬¬äºŒä¸ªæ•°ï¼‰ï¼ŒæŒ‰ä¸‹è¿ç®—ç¬¦
            if (op === '+' && isFourDigitNumber(firstOperand.toString()) && isFourDigitNumber(displayValue) && firstOperand === parseFloat(displayValue)) {
                // é­”æœ¯æ¡ä»¶æ»¡è¶³ï¼šä¸¤ä¸ªæ•°éƒ½æ˜¯å››ä½æ•°ä¸”ç›¸ç­‰
                // æš‚å­˜ç¬¬äºŒä¸ªæ“ä½œæ•°ï¼Œå‡†å¤‡é­”æœ¯
                secondOperand = current;
                operator = op;
                waitingForSecond = true;   // ç­‰å¾…ç¬¬ä¸‰ä¸ªæ•°
                magicReady = true;          // å¼€å¯é­”æœ¯é¢„å¤‡
                // ä¿æŒæ˜¾ç¤ºä¸å˜ï¼ˆæ˜¾ç¤ºç¬¬äºŒä¸ªæ•°ï¼‰
                return;
            } else {
                // æ™®é€šæƒ…å†µï¼šå…ˆè®¡ç®—ä¸­é—´ç»“æœ
                let intermediate;
                switch (operator) {
                    case '+': intermediate = firstOperand + current; break;
                    case '-': intermediate = firstOperand - current; break;
                    case '*': intermediate = firstOperand * current; break;
                    case '/': intermediate = current !== 0 ? firstOperand / current : NaN; break;
                    default: intermediate = current;
                }
                if (isNaN(intermediate)) { updateDisplay('é”™è¯¯'); resetAll(); return; }
                firstOperand = intermediate;
                updateDisplay(firstOperand.toString());
                operator = op;
                waitingForSecond = true;
                magicReady = false;
                secondOperand = null;
            }
        } else {
            // è¿ç»­æŒ‰è¿ç®—ç¬¦ï¼ˆè¿˜æ²¡è¾“å…¥ç¬¬äºŒæ•°ï¼‰â€”â€”ç®€å•å¤„ç†ä¸ºæ›´æ¢è¿ç®—ç¬¦
            operator = op;
            waitingForSecond = true;
        }
    }

    // å•ç›®è¿ç®—ï¼ˆä¿æŒåŸæœ‰åŠŸèƒ½ï¼‰
    function applyUnary(cmd, value) {
        let res;
        switch (cmd) {
            case 'sin': res = Math.sin(value); break;
            case 'cos': res = Math.cos(value); break;
            case 'tan': res = Math.tan(value); break;
            case 'ln': res = Math.log(value); break;
            case 'log': res = Math.log10(value); break;
            case 'sqrt': res = Math.sqrt(value); break;
            case 'x2': res = value * value; break;
            case '1x': res = 1 / value; break;
            case '%': res = value / 100; break;
            case 'Â±': res = -value; break;
            case 'exp': res = Math.exp(value); break;
            case 'fact': // ç®€å•é˜¶ä¹˜
                if (value < 0 || !Number.isInteger(value)) res = NaN;
                else { let f=1; for(let i=2;i<=value;i++) f*=i; res=f; }
                break;
            case 'rand': res = Math.random(); break;
            case 'pi': res = Math.PI; break;
            case 'e': res = Math.E; break;
            default: return;
        }
        if (isNaN(res) || !isFinite(res)) updateDisplay('é”™è¯¯');
        else updateDisplay(parseFloat(res.toFixed(10)).toString());
        firstOperand = null;
        operator = null;
        waitingForSecond = false;
        magicReady = false;
        secondOperand = null;
    }

    function handleCommand(cmd) {
        switch (cmd) {
            case 'c':
            case 'ce':
                displayValue = '0';
                firstOperand = null;
                operator = null;
                waitingForSecond = false;
                magicReady = false;
                secondOperand = null;
                updateDisplay('0');
                break;
            case 'back':
                displayValue = displayValue.length > 1 ? displayValue.slice(0, -1) : '0';
                updateDisplay(displayValue);
                break;
            case 'mc': memory = 0; break;
            case 'mr': displayValue = memory.toString(); updateDisplay(displayValue); waitingForSecond = false; break;
            case 'm+': memory += parseFloat(displayValue) || 0; break;
            case 'ms': memory = parseFloat(displayValue) || 0; break;
            default: break;
        }
    }

    function resetAll() {
        displayValue = '0';
        firstOperand = null;
        operator = null;
        waitingForSecond = false;
        magicReady = false;
        secondOperand = null;
        updateDisplay('0');
    }

    // ---------- æŒ‰é’®äº‹ä»¶ç»‘å®š ----------
    document.querySelectorAll('.btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const action = btn.dataset.action;
            const text = btn.innerText;

            if (action === 'num') {
                if (text === '.' && displayValue.includes('.')) return;
                handleDigit(text);
            } else if (action === '=') {
                handleOperator('=');
            } else if (['+', '-', '*', '/', 'mod', 'pow'].includes(action) || text === '+' || text === 'âˆ’' || text === 'Ã—' || text === 'Ã·') {
                let op = text;
                if (text === 'Ã—') op = '*';
                else if (text === 'Ã·') op = '/';
                else if (text === 'âˆ’') op = '-';
                else if (text === 'mod') op = '%';
                else if (text === 'xÊ¸') op = '^';
                handleOperator(op);
            } else if (action === 'c' || action === 'ce' || action === 'back' || ['mc','mr','m+','ms'].includes(action)) {
                handleCommand(action);
            } else if (action) {
                const val = parseFloat(displayValue) || 0;
                applyUnary(action, val);
            }
        });
    });

    // è¡¥å…… mod å’Œ pow çš„ç®€æ˜“å¤„ç†ï¼ˆé€šè¿‡è¦†ç›– handleOperator å¢å¼ºï¼‰
    const originalHandleOperator = handleOperator;
    handleOperator = function(op) {
        if (op === '^' || op === '%') {
            const current = parseFloat(displayValue);
            if (firstOperand === null) {
                firstOperand = current;
            } else if (!waitingForSecond) {
                let res;
                if (op === '^') res = Math.pow(firstOperand, current);
                else res = firstOperand % current;
                if (!isNaN(res)) updateDisplay(res.toString());
                firstOperand = res;
            }
            operator = op;
            waitingForSecond = true;
            magicReady = false;
            secondOperand = null;
            return;
        }
        originalHandleOperator(op);
    }.bind(this);

    // é‡æ–°ç»‘å®šäº‹ä»¶ä»¥ç¡®ä¿æ–° handleOperator ç”Ÿæ•ˆï¼ˆç®€å•å¤„ç†ï¼Œä¸å½±å“åŸç»‘å®šï¼‰
    // å¯ä»¥ç›´æ¥åœ¨ç‚¹å‡»äº‹ä»¶ä¸­è°ƒç”¨æ–°çš„ handleOperatorï¼Œä½†ä¸Šé¢å·²ç»ç»‘å®šåŒ¿åå‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨æ–°å‡½æ•°æ›¿æ¢å¼•ç”¨
    // åœ¨äº‹ä»¶ç›‘å¬ä¸­å®é™…è°ƒç”¨çš„æ˜¯ handleOperatorï¼Œæ‰€ä»¥åªéœ€å°† handleOperator å˜é‡æŒ‡å‘æ–°å‡½æ•°å³å¯ã€‚
    // ä¸Šé¢å·²ç»é€šè¿‡èµ‹å€¼æ”¹å˜äº† handleOperatorï¼Œä½†æ³¨æ„ä½œç”¨åŸŸï¼šäº‹ä»¶ç›‘å¬å†…è°ƒç”¨çš„æ˜¯å¤–éƒ¨å£°æ˜çš„ handleOperatorï¼Œç°åœ¨å·²è¢«è¦†ç›–ï¼Œæ²¡é—®é¢˜ã€‚

    // ---------- é”®ç›˜æ”¯æŒ ----------
    document.addEventListener('keydown', (e) => {
        const key = e.key;
        // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼ˆå¦‚ / è§¦å‘æœç´¢ï¼‰
        if (['/', '*', 'Enter', 'Escape', 'Backspace', 'Delete', '+', '-', '.', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9'].includes(key)) {
            e.preventDefault();
        }

        if (key === '/') {
            document.querySelector('[data-action="/"]')?.click();
        } else if (key === '*') {
            document.querySelector('[data-action="*"]')?.click();
        } else if (key === 'Enter' || key === '=') {
            document.querySelector('[data-action="="]')?.click();
        } else if (key === 'Escape') {
            document.querySelector('[data-action="c"]')?.click();  // AC
        } else if (key === 'Backspace') {
            document.querySelector('[data-action="back"]')?.click();
        } else if (key === '+') {
            document.querySelectorAll('[data-action="+"]')[0]?.click();
        } else if (key === '-') {
            document.querySelector('[data-action="-"]')?.click();
        } else if (key === '.') {
            document.querySelector('[data-action="."]')?.click();
        } else if (key >= '0' && key <= '9') {
            const numBtn = Array.from(document.querySelectorAll('[data-action="num"]')).find(btn => btn.innerText === key);
            numBtn?.click();
        }
    });

    // åˆå§‹åŒ–
    resetAll();
})();
</script>
</body>
</html>